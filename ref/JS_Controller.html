<script>
    // ============================================
    // å…¨åŸŸè®Šæ•¸æ§åˆ¶å™¨ (JS_Controller)
    // ============================================

    // å…¨åŸŸè®Šæ•¸
    let allProjectsData = [];
    let allInspectors = [];
    let disasterOptions = [];
    let currentUserInfo = null;
    let currentHolidayInfo = null;
    let currentSummaryData = [];
    let filledDates = [];
    let currentCalendarYear = new Date().getFullYear();
    let currentCalendarMonth = new Date().getMonth();
    let currentMonthHolidays = {};
    let allInspectorsWithStatus = [];
    let isGuestMode = true;
    let guestViewMode = 'tomorrow';

    // æª¢é©—å“¡éƒ¨é–€ç·¨è™Ÿå‰ç¶´æ˜ å°„
    const DEPT_CODE_MAP = {
        'åœŸæœ¨éšŠ': 'CV',
        'å»ºç¯‰éšŠ': 'AR',
        'é›»æ°£éšŠ': 'EL',
        'æ©Ÿæ¢°éšŠ': 'ME',
        'ä¸­éƒ¨éšŠ': 'CT',
        'å—éƒ¨éšŠ': 'ST',
        'å§”å¤–ç›£é€ ': 'OS'
    };

    // ============================================
    // åˆå§‹åŒ–
    // ============================================
    document.addEventListener('DOMContentLoaded', function () {
        console.log('App Initializing...');
        initGuestMode();
        setupModalOutsideClick(); // Utils
    });

    function initGuestMode() {
        isGuestMode = true;
        currentUserInfo = null;
        showMainInterface();

        // å»¶é²è¼‰å…¥ä»¥ç¢ºä¿ DOM å°±ç·’
        setTimeout(() => {
            loadGuestData();
        }, 100);

        updateUIForGuestMode();
    }

    // ============================================
    // ç™»å…¥é©—è­‰èˆ‡ UI åˆ‡æ›
    // ============================================
    function checkLoginStatus() {
        showLoading();
        google.script.run
            .withSuccessHandler(function (session) {
                hideLoading();
                if (session.isLoggedIn) {
                    currentUserInfo = session;
                    isGuestMode = false;
                    updateUIForLoggedIn();
                    loadInitialData(); // è¼‰å…¥åŸºç¤è³‡æ–™
                } else {
                    showToast('ç™»å…¥é©—è­‰å¤±æ•—', true);
                }
            })
            .withFailureHandler(function (error) {
                hideLoading();
                showToast('ç³»çµ±éŒ¯èª¤ï¼š' + error.message, true);
            })
            .getCurrentSession();
    }

    function showLoginInterface() {
        document.getElementById('loginModal').style.display = 'flex';
    }

    function hideLoginInterface() {
        document.getElementById('loginModal').style.display = 'none';
    }

    function showMainInterface() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        setupEventListeners();
    }

    function updateUIForGuestMode() {
        document.getElementById('userInfoPanel').style.display = 'none';
        document.getElementById('guestLoginBtn').style.display = 'flex';

        // éš±è— Tabs
        const tabs = document.querySelector('.tabs');
        if (tabs) tabs.style.display = 'none';

        // éš±è—æ‰€æœ‰ tab-pane
        document.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');

        // é¡¯ç¤ºç¸½è¡¨
        const summaryReport = document.getElementById('summaryReport');
        if (summaryReport) summaryReport.style.display = 'block';

        // é¡¯ç¤ºè¨ªå®¢ Card
        const guestCards = document.getElementById('guestSummaryCards');
        if (guestCards) guestCards.style.display = 'block';

        // éš±è— Controls
        const summaryControls = document.querySelector('.summary-controls');
        if (summaryControls) summaryControls.style.display = 'none';

        // éš±è— TBM
        const tbmkyCard = document.getElementById('tbmkyCard');
        if (tbmkyCard) tbmkyCard.style.display = 'none';
    }

    function updateUIForLoggedIn() {
        if (currentUserInfo) {
            document.getElementById('currentUserName').textContent = currentUserInfo.name;
            document.getElementById('currentUserRole').textContent = currentUserInfo.role;

            // é¡¯ç¤º Tabs
            const tabs = document.querySelector('.tabs');
            if (tabs) tabs.style.display = 'flex';

            // é¡¯ç¤º Controls
            const summaryControls = document.querySelector('.summary-controls');
            if (summaryControls) summaryControls.style.display = 'block';

            // éš±è—è¨ªå®¢ Card
            const guestCards = document.getElementById('guestSummaryCards');
            if (guestCards) guestCards.style.display = 'none';

            // é¡¯ç¤º TBM
            const tbmkyCard = document.getElementById('tbmkyCard');
            if (tbmkyCard) tbmkyCard.style.display = 'block';

            // é¡¯ç¤º User Info Panel
            document.getElementById('userInfoPanel').style.display = 'flex';
            document.getElementById('helpBtn').style.display = 'flex';
            document.getElementById('changePasswordBtn').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'flex';
            document.getElementById('guestLoginBtn').style.display = 'none';

            // è§’è‰²æ¬Šé™è™•ç† Tabs
            // é‡ç½®é¡¯ç¤º
            document.querySelectorAll('.tab').forEach(t => t.style.display = 'flex');

            // å„€è¡¨æ¿ Tab (dashboard) ç¸½æ˜¯å°ç™»å…¥è€…é¡¯ç¤º
            const dashboardTab = document.querySelector('.tab-dashboard');
            if (dashboardTab) dashboardTab.style.display = 'flex';

            if (currentUserInfo.role === 'å¡«è¡¨äºº') {
                if (document.querySelector('.tab-logStatus')) document.querySelector('.tab-logStatus').style.display = 'none';
                if (document.querySelector('.tab-inspectorManagement')) document.querySelector('.tab-inspectorManagement').style.display = 'none';
                if (document.querySelector('.tab-userManagement')) document.querySelector('.tab-userManagement').style.display = 'none';
            }
        }
    }

    function handleLogin(event) {
        event.preventDefault();
        const identifier = document.getElementById('loginIdentifier').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!identifier || !password) {
            showToast('è«‹è¼¸å…¥å¸³è™Ÿ/ä¿¡ç®±å’Œå¯†ç¢¼', true);
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    currentUserInfo = result.user;
                    isGuestMode = false;
                    hideLoginInterface();
                    updateUIForLoggedIn();
                    showToast(result.message);
                    setTimeout(() => {
                        loadInitialData(); // Controller or API
                        // å¡«è¡¨äººæé†’
                        if (currentUserInfo.role === 'å¡«è¡¨äºº') {
                            // checkFillerReminders() is in LogEntry or API? Let's put in LogEntry?
                            // Since it's 'Filler' specific, LogEntry makes sense, OR Utils.
                            // We will define it in JS_LogEntry.html
                            if (typeof checkFillerReminders === 'function') checkFillerReminders();
                        }
                        // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
                        if (typeof loadDashboard === 'function') loadDashboard();
                    }, 500);
                } else {
                    showToast(result.message, true);
                }
            })
            .withFailureHandler(function (error) {
                hideLoading();
                showToast('ç™»å…¥å¤±æ•—ï¼š' + error.message, true);
            })
            .authenticateUser(identifier, password);
    }

    function handleLogout() {
        showConfirmModal('ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ', function () {
            showLoading();
            google.script.run
                .withSuccessHandler(function (result) {
                    hideLoading();
                    if (result.success) {
                        location.reload();
                    }
                })
                .withFailureHandler(function (error) {
                    hideLoading();
                    showToast('ç™»å‡ºå¤±æ•—', true);
                })
                .logoutUser();
            closeConfirmModal();
        });
    }

    // ============================================
    // é ç±¤åˆ‡æ›
    // ============================================
    function switchTab(tabName) {
        if (isGuestMode && tabName !== 'summaryReport') {
            showToast('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½', true);
            showLoginInterface();
            return;
        }

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

        const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
        if (tabBtn) tabBtn.classList.add('active');

        const tabPane = document.getElementById(tabName);
        if (tabPane) tabPane.classList.add('active');

        // æ ¹æ“šé ç±¤è¼‰å…¥è³‡æ–™
        switch (tabName) {
            case 'dashboard':
                if (typeof loadDashboard === 'function') loadDashboard();
                break;
            case 'summaryReport':
                if (typeof loadSummaryReport === 'function') loadSummaryReport();
                break;
            case 'logEntry':
                if (currentUserInfo && currentUserInfo.role === 'å¡«è¡¨äºº' && typeof updateUnfilledCardsDisplay === 'function') {
                    updateUnfilledCardsDisplay();
                }
                break;
            case 'logStatus':
                if (typeof loadLogStatus === 'function') loadLogStatus();
                break;
            case 'projectSetup':
                if (typeof loadAndRenderProjectCards === 'function') loadAndRenderProjectCards();
                break;
            case 'inspectorManagement':
                if (typeof loadInspectorManagement === 'function') loadInspectorManagement();
                break;
            case 'userManagement':
                if (typeof loadUserManagement === 'function') loadUserManagement();
                break;
        }
    }

    // ============================================
    // åŸºç¤è³‡æ–™è¼‰å…¥
    // ============================================
    function loadInitialData() {
        // è¼‰å…¥å·¥ç¨‹ã€æª¢é©—å“¡ã€ç½å®³é¡å‹ç­‰
        // åŸæœ¬åœ¨ LogJavaScript.html çš„ loadInitialData
        google.script.run
            .withSuccessHandler(function (data) {
                allProjectsData = data.projects || [];
                allInspectors = data.inspectors || [];
                disasterOptions = data.disasterTypes || [];

                console.log('Initial data loaded', data);

                // è‹¥æœ‰éœ€è¦åˆå§‹åŒ–çš„ä¸‹æ‹‰é¸å–®ï¼Œåœ¨æ­¤å‘¼å«ç›¸é—œæ¸²æŸ“å‡½æ•¸
                // ä¾‹å¦‚ renderInspectorFilter() in Summary
                if (typeof renderInspectorFilter === 'function') renderInspectorFilter();
            })
            .withFailureHandler(function (e) {
                console.error(e);
                showToast('è¼‰å…¥åˆå§‹è³‡æ–™å¤±æ•—', true);
            })
            .loadInitialData(); // å¾Œç«¯ä¹Ÿè¦æœ‰é€™å€‹å‡½å¼ (åŸæœ¬å°±æœ‰)
    }

    // ============================================
    // äº‹ä»¶ç›£è½ (Global Event Listeners)
    // ============================================
    function setupEventListeners() {
        // ç™»å…¥
        const loginForm = document.getElementById('loginForm');
        if (loginForm) loginForm.addEventListener('submit', handleLogin);

        // ç™»å‡º
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

        // é ç±¤
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function () {
                const targetTab = this.getAttribute('data-tab');
                switchTab(targetTab);
            });
        });

        // å…¶ä»– Listener å»ºè­°æ”¾åœ¨å„æ¨¡çµ„çš„åˆå§‹åŒ–å‡½å¼ä¸­ï¼Œæˆ–è€…åœ¨é€™è£¡çµ±ä¸€ç¶å®š
        // ç‚ºäº†ä¿æŒ Controller ä¹¾æ·¨ï¼Œå»ºè­° LogEntry ç›¸é—œçš„å» JS_LogEntry.html ç¶å®š
        // ä½†å› ç‚º setupEventListeners æ˜¯åœ¨ MainInterface é¡¯ç¤ºæ™‚å‘¼å«ä¸€æ¬¡ï¼Œ
        // æˆ‘å€‘å¯ä»¥åœ¨é€™è£¡å‘¼å«å„æ¨¡çµ„çš„ setup function

        if (typeof setupLogEntryListeners === 'function') setupLogEntryListeners();
        if (typeof setupSummaryListeners === 'function') setupSummaryListeners();
        if (typeof setupAdminListeners === 'function') setupAdminListeners();
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('loginPassword');
        const toggleIcon = document.getElementById('passwordToggleIcon');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.textContent = 'ğŸ™ˆ';
        } else {
            passwordInput.type = 'password';
            toggleIcon.textContent = 'ğŸ‘ï¸';
        }
    }

</script>