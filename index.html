<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>綜合施工處 每日工程日誌系統</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async></script>
  <link rel="stylesheet" href="./style.css?v=3">
</head>

<body>
  <!-- 動態背景 -->


  <!-- 登入模態框 -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">🔐</span>
          登入系統
        </h2>
        <button type="button" class="modal-close" onclick="hideLoginInterface()">✕</button>
      </div>

      <div class="modal-body">
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">👤</span>
              <span>帳號或信箱</span>
            </label>
            <input type="text" id="loginIdentifier" class="form-input" required placeholder="請輸入帳號或電子信箱"
              autocomplete="username">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🔒</span>
              <span>密碼</span>
            </label>
            <div class="password-input-wrapper">
              <input type="password" id="loginPassword" class="form-input password-input" required
                placeholder="預設密碼：29340505" autocomplete="current-password">
              <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility()" title="顯示/隱藏密碼">
                <span id="passwordToggleIcon">👁️</span>
              </button>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="hideLoginInterface()" style="flex: 1;">
              <span class="btn-icon">✕</span>
              <span>取消</span>
            </button>
            <button type="submit" class="btn btn-primary" style="flex: 1;">
              <span class="btn-icon">🚀</span>
              <span>帳密登入</span>
            </button>
          </div>

          <div style="margin-top: 15px; display: flex; justify-content: center; width: 100%;">
            <div id="googleSignInButton"></div>
          </div>
        </form>

        <div style="text-align: center; margin-top: var(--spacing);">
          <a href="#" onclick="showForgotPasswordModal(); return false;"
            style="color: var(--primary); text-decoration: none; font-size: 0.9rem; cursor: pointer;">
            🔑 忘記密碼？
          </a>
        </div>

        <div
          style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--gray-300);">
          <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
            <strong>💡 提示</strong>
          </p>
          <p style="font-size: 0.85rem; color: var(--text-muted);">
            可使用「填表人資料」中的帳號或信箱登入
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- 隱藏的舊登入容器（保持兼容性） -->
  <div id="loginContainer" style="display: none;"></div>

  <!-- 主介面容器 -->
  <div id="mainContainer" class="container" style="display: none;">

    <!-- 頁首 -->
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <div class="header-icon">🏗️</div>
          <div>
            <h1 class="header-title">綜合施工處 每日工程日誌系統</h1>
            <p class="header-subtitle">Construction Daily Log Management System</p>
          </div>
        </div>

        <div class="header-right">
          <!-- 訪客模式登入按鈕 -->
          <div id="guestLoginBtn" style="display: none;">
            <button type="button" class="btn btn-primary" onclick="showLoginInterface()">
              <span class="btn-icon">🔓</span>
              <span>登入</span>
            </button>
          </div>

          <!-- 使用者資訊 -->
          <div id="userInfoPanel" class="user-info-display" style="display: none;">
            <div class="user-info-content">
              <div class="user-info-icon">👤</div>
              <div class="user-info-text">
                <div class="user-info-name" id="currentUserName">使用者名稱</div>
                <div class="user-info-role" id="currentUserRole">角色</div>
              </div>
            </div>
            <button id="helpBtn" type="button" class="btn btn-secondary" style="display: none;"
              onclick="showRoleGuideModal()" title="查看使用說明">
              <span class="btn-icon">❓</span>
              <span>使用說明</span>
            </button>
            <button id="changePasswordBtn" type="button" class="btn btn-secondary" style="display: none;"
              onclick="showChangePasswordModal()">
              <span class="btn-icon">🔑</span>
              <span>變更密碼</span>
            </button>
            <button id="logoutBtn" type="button" class="btn btn-secondary" style="display: none;">
              <span class="btn-icon">🚪</span>
              <span>登出</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- 頁籤導覽 -->
    <div class="tabs">
      <button class="tab active" data-tab="summaryReport">
        <span class="tab-icon">📊</span>
        <span class="tab-text">每日總表</span>
      </button>
      <button class="tab tab-dashboard" data-tab="dashboard" style="display: none;">
        <span class="tab-icon">📉</span>
        <span class="tab-text">儀表板</span>
      </button>
      <button class="tab" data-tab="logEntry">
        <span class="tab-icon">📝</span>
        <span class="tab-text">日誌填報</span>
      </button>
      <button class="tab tab-logStatus" data-tab="logStatus">
        <span class="tab-icon">📈</span>
        <span class="tab-text">填報狀況</span>
      </button>
      <button class="tab" data-tab="projectSetup">
        <span class="tab-icon">⚙️</span>
        <span class="tab-text">工程設定</span>
      </button>
      <button class="tab tab-inspectorManagement" data-tab="inspectorManagement">
        <span class="tab-icon">👥</span>
        <span class="tab-text">檢驗員管理</span>
      </button>
      <button class="tab tab-userManagement" data-tab="userManagement" style="display: none;">
        <span class="tab-icon">🔐</span>
        <span class="tab-text">使用者管理</span>
      </button>
    </div>

    <!-- ============================================ -->
    <!-- 頁籤：每日總表 -->
    <!-- ============================================ -->
    <div id="summaryReport" class="tab-pane active">
      <div class="glass-card" style="margin-bottom: 2rem;">
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; justify-content: space-between;">
          <div style="display: flex; gap: 1rem; align-items: flex-end;">
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">選擇日期</label>
              <input type="date" id="summaryDatePicker" class="form-input">
            </div>
            <button type="button" id="refreshSummary" class="btn btn-secondary btn-icon-only" title="重新整理">
              <span class="btn-icon">🔄</span>
            </button>
          </div>

          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div class="toggle-group">
              <label class="toggle-btn">
                <input type="radio" name="summaryStatusFilter" value="active" checked>
                <span>施工中</span>
              </label>
              <label class="toggle-btn">
                <input type="radio" name="summaryStatusFilter" value="all">
                <span>全部</span>
              </label>
            </div>

            <select id="summaryDeptFilter" class="form-select" style="min-width: 120px;">
              <option value="all">全部部門</option>
            </select>

            <select id="summaryInspectorFilter" class="form-select" style="min-width: 120px;">
              <option value="all">全部檢驗員</option>
            </select>

            <div class="view-mode-switch">
              <button class="mode-btn active" data-mode="list" title="列表檢視">📋</button>
              <button class="mode-btn" data-mode="card" title="卡片檢視">📇</button>
            </div>
          </div>
        </div>

        <div id="guestInfoBar"
          style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 0.9rem;">
          <div>
            📅 <span id="guestDateDisplay">--</span>
            <span style="margin: 0 0.5rem;">|</span>
            🏗️ 今日施工：<strong id="guestProjectCount" style="color: var(--primary);">0</strong> 案
          </div>
          <div class="guest-toggle-group" id="guestToggleGroup">
            <button id="guestBtnToday" class="guest-toggle-btn" onclick="toggleGuestDate('today')">今日</button>
            <button id="guestBtnTomorrow" class="guest-toggle-btn active"
              onclick="toggleGuestDate('tomorrow')">明日</button>
          </div>
        </div>
      </div>

      <div id="summaryListView" class="table-container glass-card" style="padding: 0;">
        <table class="summary-table" style="width: 100%;">
          <thead id="summaryTableHead"></thead>
          <tbody id="summaryTableBody"></tbody>
        </table>
      </div>

      <div id="summaryMobileView" style="display: none;"></div>
    </div>

    <!-- ============================================ -->
    <!-- 頁籤：儀表板 -->
    <!-- ============================================ -->
    <div id="dashboard" class="tab-pane">
      <!-- 控制區：年份與月份選擇 -->
      <div class="glass-card"
        style="margin-bottom: 1.5rem; padding: 1.5rem; display: flex; gap: 1rem; align-items: flex-end;">
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">選擇年份</label>
          <select id="dashYearSelect" class="form-select" style="min-width: 120px;"></select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">選擇月份</label>
          <select id="dashMonthSelect" class="form-select" style="min-width: 100px;"></select>
        </div>
        <button class="btn btn-primary" onclick="loadMonthlyDashboard()">
          <span>🔄 更新統計</span>
        </button>
      </div>

      <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
        <!-- 出工日數統計 -->
        <div class="glass-card" style="padding: 1.5rem;">
          <canvas id="chart-work-days" style="max-height: 600px;"></canvas>
        </div>

        <!-- 危害統計 -->
        <div class="glass-card" style="padding: 1.5rem;">
          <canvas id="chart-hazards" style="max-height: 400px;"></canvas>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 頁籤1：日誌填報 -->
    <!-- ============================================ -->
    <div id="logEntry" class="tab-pane">

      <!-- 未填寫提醒（改為多卡片顯示） -->
      <div id="unfilledCardsContainer" style="display: none; margin-bottom: var(--spacing-lg);">
        <!-- 動態生成提醒卡片 -->
      </div>

      <!-- 假日提示 -->
      <div id="holidayAlert" class="alert-holiday" style="display: none;">
        <div class="holiday-alert-content">
          <div class="holiday-icon">🏖️</div>
          <div class="holiday-info">
            <strong id="holidayDateInfo">假日資訊</strong>
            <p id="holidayRemark" class="holiday-remark"></p>

            <div style="margin-top: 0.5rem; display: flex; gap: 1rem; font-weight: 600; color: var(--warning-dark);">
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" id="checkSat"> 六
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" id="checkSun"> 日
              </label>
              <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                <input type="checkbox" id="checkHoliday"> 例假
              </label>
            </div>
          </div>
        </div>



        <!-- 填報表單 -->
        <div class="glass-card">
          <div class="card-header">
            <div class="card-header-content">
              <div class="card-icon">📝</div>
              <div>
                <h2 class="card-title">每日施工日誌填報</h2>
                <p class="card-desc">請填寫明日預定施工內容</p>
              </div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="copyLastWorkItems()" style="margin-left: auto;">
              <span class="btn-icon">📋</span>
              <span>複製上次填寫</span>
            </button>
            <!-- [新增] 批次假日設定按鈕 -->
            <button type="button" class="btn btn-warning" onclick="showBatchHolidayModal()"
              style="margin-left: 0.5rem;">
              <span class="btn-icon">📅</span>
              <span>批次假日設定</span>
            </button>
          </div>

          <form id="dailyLogForm">

            <!-- 基本資訊 -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  <span class="label-icon">📅</span>
                  <span>填報日期 <span class="required">*</span></span>
                </label>
                <input type="date" id="logDatePicker" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <span class="label-icon">🏗️</span>
                  <span>工程名稱 <span class="required">*</span></span>
                </label>
                <select id="logProjectSelect" class="form-select" required>
                  <option value="">請選擇工程</option>
                </select>
              </div>
            </div>

            <!-- 假日施工選項 -->
            <div id="holidayWorkGroup" class="form-group" style="display: none;">
              <label class="form-label">
                <span class="label-icon">🏗️</span>
                <span>假日施工選項</span>
              </label>

              <div class="checkbox-item-holiday">
                <input type="checkbox" id="isHolidayWork" name="holidayOption">
                <span>✓ 假日施工（照常施工）</span>
              </div>

              <div class="checkbox-item-holiday-no-work">
                <input type="checkbox" id="isHolidayNoWork" name="holidayOption">
                <span>🏖️ 假日不施工（停止施工）</span>
              </div>
            </div>

            <!-- 檢驗員選擇 -->
            <div id="inspectorGroup" class="form-group">
              <div
                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-sm);">
                <label class="form-label" style="margin-bottom: 0;">
                  <span class="label-icon">👥</span>
                  <span>檢驗員 <span class="required">*</span></span>
                </label>
                <button type="button" id="changeInspectorBtn" class="btn btn-secondary btn-mini" style="display: none;">
                  <span>✏️ 修改檢驗員</span>
                </button>
              </div>
              <div id="inspectorDisplay"
                style="display: none; padding: var(--spacing); background: var(--gray-50); border: 2px solid var(--success); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
                <div id="inspectorDisplayText" style="color: var(--text-primary); font-weight: 600;"></div>
              </div>
              <div id="inspectorCheckboxes" class="checkbox-grid" style="display: none;">
                <!-- 動態生成 -->
              </div>
            </div>

            <!-- 施工人數 -->
            <div id="workersCountGroup" class="form-group">
              <label class="form-label">
                <span class="label-icon">🧑‍🔧</span>
                <span>施工人數 <span class="required">*</span></span>
              </label>
              <input type="number" id="logWorkersCount" class="form-input" min="0" required placeholder="請輸入施工人數">
            </div>

            <!-- 修正7：工項配對區（改為「新增工項」） -->
            <div id="workItemsGroup" class="form-group">
              <label class="form-label">
                <span class="label-icon">🛠️</span>
                <span>工作項目與災害配對 <span class="required">*</span></span>
              </label>

              <div id="workItemsContainer">
                <!-- 動態生成工項 -->
              </div>

              <button type="button" id="addWorkItemBtn" class="btn btn-secondary" style="margin-top: 1rem;">
                <span class="btn-icon">➕</span>
                <span>新增工項</span>
              </button>
            </div>

            <!-- 提交按鈕 -->
            <button type="submit" class="btn btn-primary btn-lg">
              <span class="btn-icon">📤</span>
              <span>提交日誌</span>
            </button>
          </form>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- 頁籤2：每日預定工程日誌總表 -->
      <!-- ============================================ -->
      <div id="summaryReport" class="tab-pane active">

        <!-- 訪客模式卡片（未登入時顯示） -->
        <div id="guestSummaryCards" style="display: none; margin-bottom: 2rem;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div
              style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 16px; padding: 2rem; color: white; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3); position: relative;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <span style="font-size: 2.5rem;">📅</span>
                  <span id="guestDateLabel" style="font-size: 1.1rem; font-weight: 600; opacity: 0.9;">日誌日期</span>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button type="button" id="guestBtnToday" class="guest-mode-btn active"
                    onclick="toggleGuestDate('today')">今日</button>
                  <button type="button" id="guestBtnTomorrow" class="guest-mode-btn"
                    onclick="toggleGuestDate('tomorrow')">明日</button>
                </div>
              </div>
              <div id="guestDateDisplay" style="font-size: 2rem; font-weight: 700; margin-top: 0.75rem;">
                --
              </div>
            </div>

            <div
              style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 2rem; color: white; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);">
              <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 2.5rem;">🏗️</span>
                <span id="guestProjectLabel" style="font-size: 1.1rem; font-weight: 600; opacity: 0.9;">明日施工工程</span>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-top: 0.75rem;">
                <span id="guestProjectCount" style="font-size: 2.5rem; font-weight: 700;">0</span>
                <span style="font-size: 1.2rem; opacity: 0.9;">項</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 控制區 -->
        <div class="summary-controls">
          <div class="control-group">
            <label class="form-label">
              <span class="label-icon">📅</span>
              <span>選擇日期</span>
            </label>
            <input type="date" id="summaryDatePicker" class="form-input">
          </div>

          <div class="control-group">
            <label class="form-label">
              <span class="label-icon">🏢</span>
              <span>部門篩選</span>
            </label>
            <select id="summaryDeptFilter" class="form-select">
              <option value="all">全部部門</option>
            </select>
          </div>

          <!-- [新增] 檢驗員篩選 -->
          <div class="control-group">
            <label class="form-label">
              <span class="label-icon">👥</span>
              <span>檢驗員篩選</span>
            </label>
            <select id="summaryInspectorFilter" class="form-select">
              <option value="all">全部檢驗員</option>
            </select>
          </div>

          <div class="control-group">
            <label class="form-label">
              <span class="label-icon">🔍</span>
              <span>工程狀態</span>
            </label>
            <div class="filter-toggle">
              <label class="filter-option">
                <input type="radio" name="summaryStatusFilter" value="all">
                <span>全部工程</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="summaryStatusFilter" value="active" checked>
                <span>施工中</span>
              </label>
            </div>
          </div>

          <div class="control-group">
            <button id="refreshSummary" class="btn btn-primary" style="margin-top: 1.75rem;">
              <span class="btn-icon">🔄</span>
              <span>重新整理</span>
            </button>
          </div>
        </div>

        <!-- 模式切換 -->
        <div class="glass-card">
          <div class="card-header">
            <div class="card-header-content">
              <div class="card-icon">📊</div>
              <div>
                <h2 class="card-title">每日預定工程日誌總表</h2>
              </div>
            </div>
            <div id="modeToggle" class="mode-toggle">
              <button class="mode-btn active" data-mode="list">
                <span>📋 列表模式</span>
              </button>
              <button id="calendarModeBtn" class="mode-btn" data-mode="calendar">
                <span>📅 日曆模式</span>
              </button>
            </div>
          </div>

          <!-- 列表檢視 -->
          <div id="summaryListView">
            <div class="summary-table-container">
              <table class="summary-table">
                <thead id="summaryTableHead">
                  <tr>
                    <th>序號</th>
                    <th>工程名稱</th>
                    <th>承攬商</th>
                    <th>部門</th>
                    <th>檢驗員</th>
                    <th>工地負責人</th>
                    <th>職安人員</th>
                    <th>工作地址</th>
                    <th>施工人數</th>
                    <th>主要工作項目</th>
                    <th>主要災害類型</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="summaryTableBody">
                  <tr>
                    <td colspan="12" class="text-muted">請選擇日期載入資料</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="summaryMobileView" class="mobile-view-container" style="display: none;">
            </div>


          </div>





          <!-- 日曆檢視 -->
          <div id="summaryCalendarView" style="display: none;">
            <div class="calendar-header">
              <button class="btn btn-secondary" onclick="changeMonth(-1)">
                <span>◀ 上個月</span>
              </button>
              <h3 id="calendarTitle">2025年1月</h3>
              <button class="btn btn-secondary" onclick="changeMonth(1)">
                <span>下個月 ▶</span>
              </button>
            </div>
            <div id="calendarGrid" class="calendar-grid">
              <!-- 動態生成 -->
            </div>
          </div>
        </div>

        <!-- TBM-KY 生成 -->
        <div id="tbmkyCard" class="glass-card">
          <div class="card-header">
            <div class="card-header-content">
              <div class="card-icon">📋</div>
              <div>
                <h2 class="card-title">TBM-KY 文件生成</h2>
                <p class="card-desc">依據日誌內容自動生成 TBM-KY 文件</p>
              </div>
            </div>
          </div>
          <button id="generateTBMKYBtn" class="btn btn-success btn-lg">
            <span class="btn-icon">📄</span>
            <span>生成 TBM-KY 文件</span>
          </button>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- 頁籤3：日誌填報狀況總覽 -->
      <!-- ============================================ -->
      <div id="logStatus" class="tab-pane">

        <div class="glass-card">
          <div class="card-header">
            <div class="card-header-content">
              <div class="card-icon">📈</div>
              <div>
                <h2 class="card-title">日誌填報狀況總覽</h2>
                <p class="card-desc">明日（<span id="statusTomorrowDate"></span>）填報進度</p>
              </div>
            </div>
            <button id="refreshLogStatus" class="btn btn-secondary">
              <span class="btn-icon">🔄</span>
              <span>重新整理</span>
            </button>
          </div>

          <!-- 統計卡片 -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="statTotalProjects">0</div>
              <div class="stat-label">施工中工程</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statFilledTomorrow">0</div>
              <div class="stat-label">已填寫</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statCompletionRate">0%</div>
              <div class="stat-label">完成率</div>
            </div>
          </div>

          <!-- 部門詳情 -->
          <div id="deptCardsContainer">
            <!-- 動態生成 -->
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- 頁籤4：工程設定 -->
      <!-- ============================================ -->
      <div id="projectSetup" class="tab-pane">

        <!-- 篩選控制 -->
        <div class="project-filter-controls">
          <div class="filter-row">
            <div class="filter-group">
              <label class="form-label">
                <span class="label-icon">🏢</span>
                <span>部門篩選</span>
              </label>
              <select id="projectDeptFilter" class="form-select">
                <option value="all">全部部門</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="form-label">
                <span class="label-icon">🔍</span>
                <span>工程狀態</span>
              </label>
              <div class="filter-toggle">
                <label class="filter-option">
                  <input type="radio" name="projectStatusFilter" value="all" checked>
                  <span>全部工程</span>
                </label>
                <label class="filter-option">
                  <input type="radio" name="projectStatusFilter" value="active">
                  <span>施工中</span>
                </label>
              </div>
            </div>

            <div class="filter-group">
              <button id="refreshProjectList" class="btn btn-primary" style="margin-top: 1.75rem;">
                <span class="btn-icon">🔄</span>
                <span>重新整理</span>
              </button>
            </div>
          </div>
        </div>

        <!-- 工程卡片 -->
        <div class="glass-card">
          <div class="card-header">
            <div class="card-header-content">
              <div class="card-icon">⚙️</div>
              <div>
                <h2 class="card-title">工程基本資料管理</h2>
                <p class="card-desc">點擊卡片可編輯工程資料</p>
              </div>
            </div>
          </div>

          <div id="projectCardsContainer" class="project-cards-grid">
            <!-- 動態生成 -->
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- 頁籤5：檢驗員及委外監造資料管理 -->
      <!-- ============================================ -->
      <div id="inspectorManagement" class="tab-pane">

        <!-- 篩選控制 -->
        <div class="inspector-filter-controls">
          <div class="filter-row">
            <div class="filter-group">
              <label class="form-label">
                <span class="label-icon">🏢</span>
                <span>部門篩選</span>
              </label>
              <select id="inspectorDeptFilter" class="form-select">
                <option value="all">全部部門</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="form-label">
                <span class="label-icon">🔍</span>
                <span>狀態篩選</span>
              </label>
              <div class="filter-toggle">
                <label class="filter-option">
                  <input type="radio" name="inspectorStatusFilter" value="all" checked>
                  <span>全部狀態</span>
                </label>
                <label class="filter-option">
                  <input type="radio" name="inspectorStatusFilter" value="active">
                  <span>啟用中</span>
                </label>
              </div>
            </div>

            <div class="filter-group">
              <button id="refreshInspectorList" class="btn btn-primary" style="margin-top: 1.75rem;">
                <span class="btn-icon">🔄</span>
                <span>重新整理</span>
              </button>
            </div>
          </div>
        </div>

        <!-- 檢驗員卡片 -->
        <div class="glass-card">
          <div class="card-header">
            <div class="card-header-content">
              <div class="card-icon">👥</div>
              <div>
                <h2 class="card-title">檢驗員及委外監造資料管理</h2>
                <p class="card-desc">管理所有檢驗員與委外監造人員</p>
              </div>
            </div>
            <button id="addInspectorBtn" class="btn btn-success">
              <span class="btn-icon">➕</span>
              <span>新增檢驗員</span>
            </button>
          </div>

          <div id="inspectorCardsContainer" class="inspector-cards-grid">
            <!-- 動態生成 -->
          </div>
        </div>
      </div>

    </div>

    <!-- ============================================ -->
    <!-- 彈窗：編輯總表日誌 -->
    <!-- ============================================ -->
    <div id="editSummaryLogModal" class="modal">
      <div class="modal-content modal-lg">
        <div class="modal-header">
          <h3>編輯日誌</h3>
          <button class="modal-close" onclick="closeEditSummaryLogModal()">×</button>
        </div>
        <div class="modal-body">
          <p class="modal-subtitle" id="editSummaryLogProjectName"></p>

          <input type="hidden" id="editSummaryLogDate">
          <input type="hidden" id="editSummaryLogProjectSeqNo">
          <input type="hidden" id="editSummaryIsHolidayNoWork">

          <!-- 假日標記 -->
          <div id="editHolidayNoWorkBadge" class="alert alert-info" style="display: none;">
            <strong>🏖️ 此為假日不施工記錄</strong>
            <p>若要修改請刪除後重新填寫</p>
          </div>

          <div id="editHolidayWorkBadge" class="alert alert-warning" style="display: none;">
            <strong>🏗️ 假日施工</strong>
          </div>

          <!-- 假日施工切換 -->
          <div id="editHolidayWorkToggle" class="form-group" style="display: none;">
            <label class="checkbox-item-holiday">
              <input type="checkbox" id="editIsHolidayWork">
              <span>✓ 假日施工</span>
            </label>
          </div>

          <!-- 檢驗員 -->
          <div id="editSummaryInspectorGroup" class="form-group">
            <label class="form-label">
              <span class="label-icon">👥</span>
              <span>檢驗員（可多選）</span>
            </label>
            <div id="editInspectorCheckboxes" class="checkbox-grid">
              <!-- 動態生成 -->
            </div>
          </div>

          <!-- 施工人數 -->
          <div id="editSummaryWorkersGroup" class="form-group">
            <label class="form-label">
              <span class="label-icon">🧑‍🔧</span>
              <span>施工人數</span>
            </label>
            <input type="number" id="editSummaryWorkersCount" class="form-input" min="0">
          </div>

          <!-- 工項列表 -->
          <div id="editSummaryWorkItemsGroup" class="form-group">
            <label class="form-label">
              <span class="label-icon">🛠️</span>
              <span>工作項目</span>
            </label>
            <div id="editWorkItemsList">
              <!-- 動態生成 -->
            </div>
            <button type="button" class="btn btn-secondary" onclick="copyPreviousDayData()" style="margin-top: 1rem;">
              <span class="btn-icon">📋</span>
              <span>複製前一天資料</span>
            </button>
          </div>

          <!-- 修改原因 -->
          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📝</span>
              <span>修改原因 <span class="required">*</span></span>
            </label>
            <textarea id="editSummaryReason" class="form-textarea" rows="2" required placeholder="請簡述修改原因"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeEditSummaryLogModal()">取消</button>
          <button type="button" class="btn btn-primary" onclick="confirmEditSummaryLog()">
            <span class="btn-icon">✓</span>
            <span>確認修改</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：填表人未填寫提醒 -->
    <!-- ============================================ -->
    <div id="fillerReminderModal" class="modal">
      <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>📋 填寫提醒</h3>
          <button class="modal-close" onclick="closeFillerReminderModal()">×</button>
        </div>
        <div class="modal-body" id="fillerReminderContent" style="max-height: calc(85vh - 140px); overflow-y: auto;">
          <!-- 動態生成 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeFillerReminderModal()">我知道了</button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- [新增] 彈窗：批次假日設定 -->
    <!-- ============================================ -->
    <div id="batchHolidayModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <span class="modal-icon">📅</span>
            批次假日設定
          </h3>
          <button class="modal-close" onclick="closeBatchHolidayModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <p>此功能可批次將指定日期範圍內的「週末」設為「假日不施工」。</p>
          </div>

          <div class="form-group">
            <label class="form-label">日期範圍</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="font-size: 0.9rem; color: var(--text-muted);">開始日期</label>
                <input type="date" id="batchStartDate" class="form-input">
              </div>
              <div>
                <label style="font-size: 0.9rem; color: var(--text-muted);">結束日期</label>
                <input type="date" id="batchEndDate" class="form-input">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">設定對象</label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" id="batchCheckSat" checked>
                <span>星期六</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="batchCheckSun" checked>
                <span>星期日</span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">選擇工程</label>
            <div style="margin-bottom: 0.5rem;">
              <label class="checkbox-item">
                <input type="checkbox" id="batchSelectAllProjects" onchange="toggleBatchAllProjects(this)">
                <span>全選所有施工中工程</span>
              </label>
            </div>
            <div id="batchProjectList" class="checkbox-grid"
              style="max-height: 200px; overflow-y: auto; border: 1px solid var(--gray-300); padding: 0.5rem; border-radius: var(--radius);">
              <!-- 動態生成工程列表 -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeBatchHolidayModal()">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitBatchHoliday()">
            <span class="btn-icon">🚀</span>
            <span>開始批次設定</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：變更密碼 -->
    <!-- ============================================ -->
    <!-- 使用說明模態框 -->
    <div id="roleGuideModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3>
            <span class="modal-icon">📚</span>
            使用說明
          </h3>
          <button class="modal-close" onclick="closeRoleGuideModal()">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

          <!-- 填表人職責 -->
          <div id="fillerGuide" style="display: none;">
            <div
              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 1.3rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">👤</span>
                填表人職責
              </h4>
              <p style="margin: 0; opacity: 0.95; font-size: 0.95rem;">您的主要任務是填寫每日工程日誌並管理工程設定</p>
            </div>

            <div
              style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1rem; border-left: 4px solid var(--primary);">
              <h5 style="margin: 0 0 1rem 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                <span>📝</span>
                <span>1. 填寫每日日誌撰寫</span>
              </h5>
              <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li>每天填寫明日預定施工內容</li>
                <li>記錄施工人數、檢驗員、工作項目</li>
                <li>選擇對應的災害類型</li>
                <li>假日施工需特別標註</li>
              </ul>
            </div>

            <div
              style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid var(--success);">
              <h5 style="margin: 0 0 1rem 0; color: var(--success); display: flex; align-items: center; gap: 0.5rem;">
                <span>⚙️</span>
                <span>2. 管理工程設定</span>
              </h5>
              <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>工地負責人：</strong>填寫姓名與電話</li>
                <li><strong>職安人員：</strong>填寫姓名與電話</li>
                <li><strong>工程狀態：</strong>更新為「施工中」、「已完工」等</li>
                <li><strong>預設檢驗員：</strong>設定常用的檢驗員</li>
              </ul>
            </div>

            <div
              style="background: #fff3cd; padding: 1rem; border-radius: var(--radius); margin-top: 1.5rem; border: 2px solid #ffc107;">
              <p style="margin: 0; color: #856404; display: flex; align-items: flex-start; gap: 0.5rem;">
                <span style="font-size: 1.2rem;">💡</span>
                <span><strong>提示：</strong>如需新增工程或修改其他設定，請聯繫聯絡員協助處理。</span>
              </p>
            </div>
          </div>

          <!-- 聯絡員職責 -->
          <div id="contactGuide" style="display: none;">
            <div
              style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 1.3rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">🔧</span>
                聯絡員職責
              </h4>
              <p style="margin: 0; opacity: 0.95; font-size: 0.95rem;">您負責系統管理與使用者權限設定</p>
            </div>

            <div
              style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1rem; border-left: 4px solid #e91e63;">
              <h5 style="margin: 0 0 1rem 0; color: #e91e63; display: flex; align-items: center; gap: 0.5rem;">
                <span>👥</span>
                <span>1. 使用者管理</span>
              </h5>
              <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>建立填表人：</strong>新增填表人帳號</li>
                <li><strong>設定帳號密碼：</strong>為填表人設定登入資訊</li>
                <li><strong>設定信箱：</strong>填寫填表人的 Email 地址</li>
                <li><strong>分配工程：</strong>設定填表人要填報的工程序號</li>
              </ul>
            </div>

            <div
              style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1rem; border-left: 4px solid #ff9800;">
              <h5 style="margin: 0 0 1rem 0; color: #ff9800; display: flex; align-items: center; gap: 0.5rem;">
                <span>🏗️</span>
                <span>2. 管理工程設定</span>
              </h5>
              <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>更新工程狀態：</strong>標記工程為「施工中」、「已完工」等</li>
                <li><strong>設定預設檢驗員：</strong>為工程指定常用檢驗員</li>
              </ul>
            </div>

            <div
              style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid #4caf50;">
              <h5 style="margin: 0 0 1rem 0; color: #4caf50; display: flex; align-items: center; gap: 0.5rem;">
                <span>🔍</span>
                <span>3. 檢驗員管理</span>
              </h5>
              <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>建立檢驗員：</strong>新增檢驗員資料</li>
                <li><strong>設定姓名與專業：</strong>填寫檢驗員的專業領域</li>
              </ul>
            </div>

            <div
              style="background: #d1ecf1; padding: 1rem; border-radius: var(--radius); margin-top: 1.5rem; border: 2px solid #17a2b8;">
              <p style="margin: 0; color: #0c5460; display: flex; align-items: flex-start; gap: 0.5rem;">
                <span style="font-size: 1.2rem;">ℹ️</span>
                <span><strong>注意：</strong>聯絡員擁有較高權限，請謹慎操作使用者與工程資料。</span>
              </p>
            </div>
          </div>

          <!-- 通用說明（所有角色都顯示） -->
          <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px dashed var(--gray-300);">
            <h5
              style="margin: 0 0 1rem 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
              <span>🔐</span>
              <span>帳號安全</span>
            </h5>
            <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8; color: var(--text-secondary);">
              <li>首次登入後請立即變更預設密碼</li>
              <li>定期更新密碼以確保帳號安全</li>
              <li>不要與他人分享您的帳號密碼</li>
            </ul>
          </div>

          <div style="margin-top: 1.5rem;">
            <h5
              style="margin: 0 0 1rem 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
              <span>📧</span>
              <span>技術支援</span>
            </h5>
            <p style="margin: 0; padding-left: 1.5rem; line-height: 1.8; color: var(--text-secondary);">
              如有任何問題或需要協助，請聯繫系統管理員。
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeRoleGuideModal()">
            <span class="btn-icon">✓</span>
            <span>我知道了</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 變更密碼模態框 -->
    <div id="changePasswordModal" class="modal">
      <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
          <h3>變更密碼</h3>
          <button class="modal-close" onclick="closeChangePasswordModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🔒</span>
              <span>舊密碼 <span class="required">*</span></span>
            </label>
            <input type="password" id="oldPassword" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🔑</span>
              <span>新密碼 <span class="required">*</span></span>
            </label>
            <input type="password" id="newPassword" class="form-input" required>
            <p class="form-hint">密碼長度至少 6 位</p>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">✓</span>
              <span>確認新密碼 <span class="required">*</span></span>
            </label>
            <input type="password" id="confirmPassword" class="form-input" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitChangePassword()">
            <span class="btn-icon">💾</span>
            <span>確認變更</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：編輯工程資料 -->
    <!-- ============================================ -->
    <div id="editProjectModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>編輯工程資料</h3>
          <button class="modal-close" onclick="closeEditProjectModal()">×</button>
        </div>
        <div class="modal-body">
          <p class="modal-subtitle" id="editProjectName"></p>

          <input type="hidden" id="editProjectSeqNo">

          <!-- 兩欄佈局 -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">
                <span class="label-icon">👷</span>
                <span>工地負責人 <span class="required">*</span></span>
              </label>
              <input type="text" id="editResp" class="form-input" required>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">
                <span class="label-icon">📞</span>
                <span>負責人電話</span>
              </label>
              <input type="tel" id="editRespPhone" class="form-input" placeholder="選填">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">
                <span class="label-icon">🦺</span>
                <span>職安人員 <span class="required">*</span></span>
              </label>
              <input type="text" id="editSafetyOfficer" class="form-input" required>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">
                <span class="label-icon">📜</span>
                <span>證照</span>
              </label>
              <select id="editSafetyLicense" class="form-select">
                <option value="">請選擇</option>
                <option value="甲安">甲安</option>
                <option value="甲衛">甲衛</option>
                <option value="乙員">乙員</option>
                <option value="甲業">甲業</option>
                <option value="營造甲業">營造甲業</option>
                <option value="乙業">乙業</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">
                <span class="label-icon">📞</span>
                <span>職安電話</span>
              </label>
              <input type="tel" id="editSafetyPhone" class="form-input" placeholder="選填">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📊</span>
              <span>工程狀態 <span class="required">*</span></span>
            </label>
            <select id="editProjectStatus" class="form-select" required>
              <option value="施工中">施工中</option>
              <option value="竣工">竣工</option>
              <option value="暫停施工">暫停施工</option>
            </select>
          </div>

          <!-- 狀態備註（非施工中時必填） -->
          <div id="editStatusRemarkGroup" class="form-group" style="display: none;">
            <label class="form-label">
              <span class="label-icon">📝</span>
              <span>狀態備註 <span class="required">*</span></span>
            </label>
            <textarea id="editStatusRemark" class="form-textarea" rows="2" placeholder="請說明竣工或暫停施工的原因"></textarea>
            <p class="form-hint">⚠️ 工程狀態為「竣工」或「暫停施工」時，必須填寫備註說明原因</p>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">👥</span>
              <span>預設檢驗員</span>
            </label>
            <div id="editDefaultInspectorCheckboxes" class="checkbox-grid">
              <!-- 動態生成 -->
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📝</span>
              <span>修改原因 <span class="required">*</span></span>
            </label>
            <textarea id="editProjectReason" class="form-textarea" rows="2" required placeholder="請簡述修改原因"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()">取消</button>
          <button type="button" class="btn btn-primary" onclick="confirmEditProject()">
            <span class="btn-icon">✓</span>
            <span>確認修改</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：新增檢驗員 -->
    <!-- ============================================ -->
    <div id="addInspectorModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>新增檢驗員</h3>
          <button class="modal-close" onclick="closeAddInspectorModal()">×</button>
        </div>
        <div class="modal-body">
          <div
            style="background-color: var(--primary-light); padding: var(--spacing); border-radius: 8px; margin-bottom: var(--spacing-lg);">
            <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">
              <strong>🔢 自動編號：</strong>
              <span id="addInspectorIdPreview" style="font-size: 1.1rem; margin-left: 0.5rem;">請先選擇部門</span>
            </p>
          </div>

          <!-- 修正10：專業選項改為「土木、機械、電氣」 -->
          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🏢</span>
              <span>部門 <span class="required">*</span></span>
            </label>
            <select id="addInspectorDept" class="form-select" required onchange="updateInspectorIdPreview()">
              <option value="">請選擇部門</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">👤</span>
              <span>姓名 <span class="required">*</span></span>
            </label>
            <input type="text" id="addInspectorName" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🎓</span>
              <span>職稱 <span class="required">*</span></span>
            </label>
            <input type="text" id="addInspectorTitle" class="form-input" required placeholder="例如：工程師、技師等">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🔧</span>
              <span>專業 <span class="required">*</span></span>
            </label>
            <select id="addInspectorProfession" class="form-select" required>
              <option value="">請選擇專業</option>
              <option value="土木">土木</option>
              <option value="機械">機械</option>
              <option value="電氣">電氣</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📞</span>
              <span>電話</span>
            </label>
            <input type="tel" id="addInspectorPhone" class="form-input" placeholder="選填">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📝</span>
              <span>新增原因 <span class="required">*</span></span>
            </label>
            <textarea id="addInspectorReason" class="form-textarea" rows="2" required placeholder="請簡述新增原因"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeAddInspectorModal()">取消</button>
          <button type="button" class="btn btn-success" onclick="confirmAddInspector()">
            <span class="btn-icon">✓</span>
            <span>確認新增</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：編輯檢驗員 -->
    <!-- ============================================ -->
    <div id="editInspectorModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>編輯檢驗員資料</h3>
          <button class="modal-close" onclick="closeEditInspectorModal()">×</button>
        </div>
        <div class="modal-body">
          <p class="modal-subtitle">編號：<strong id="editInspectorIdDisplay"></strong>（不可修改）</p>

          <input type="hidden" id="editInspectorId">

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🏢</span>
              <span>部門 <span class="required">*</span></span>
            </label>
            <select id="editInspectorDept" class="form-select" required>
              <option value="">請選擇部門</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">👤</span>
              <span>姓名 <span class="required">*</span></span>
            </label>
            <input type="text" id="editInspectorName" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🎓</span>
              <span>職稱 <span class="required">*</span></span>
            </label>
            <input type="text" id="editInspectorTitle" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🔧</span>
              <span>專業 <span class="required">*</span></span>
            </label>
            <select id="editInspectorProfession" class="form-select" required>
              <option value="">請選擇專業</option>
              <option value="土木">土木</option>
              <option value="機械">機械</option>
              <option value="電氣">電氣</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📞</span>
              <span>電話</span>
            </label>
            <input type="tel" id="editInspectorPhone" class="form-input" placeholder="選填">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📝</span>
              <span>修改原因 <span class="required">*</span></span>
            </label>
            <textarea id="editInspectorReason" class="form-textarea" rows="2" required placeholder="請簡述修改原因"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeEditInspectorModal()">取消</button>
          <button type="button" class="btn btn-primary" onclick="confirmEditInspector()">
            <span class="btn-icon">✓</span>
            <span>確認修改</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：TBM-KY 生成 -->
    <!-- ============================================ -->
    <div id="tbmkyModal" class="modal">
      <div class="modal-content modal-sm">
        <div class="modal-header">
          <h3>生成 TBM-KY 文件</h3>
          <button class="modal-close" onclick="closeTBMKYModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">🏗️</span>
              <span>選擇工程</span>
            </label>
            <select id="tbmkyProjectSelect" class="form-select">
              <option value="">請選擇工程</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📅</span>
              <span>選擇日期</span>
            </label>
            <input type="date" id="tbmkyDatePicker" class="form-input">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">📝</span>
              <span>生成模式</span>
            </label>
            <label class="checkbox-item-large">
              <input type="radio" name="tbmkyMode" value="merged" checked>
              <span>合併模式（一個檔案）</span>
            </label>
            <label class="checkbox-item-large">
              <input type="radio" name="tbmkyMode" value="separate">
              <span>分開模式（每個工項一個檔案）</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeTBMKYModal()">取消</button>
          <button type="button" class="btn btn-success" onclick="confirmGenerateTBMKY()">
            <span class="btn-icon">📄</span>
            <span>開始生成</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：TBM-KY 生成結果 -->
    <!-- ============================================ -->
    <div id="tbmkyResultModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>TBM-KY 生成完成</h3>
          <button class="modal-close" onclick="closeTBMKYResultModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="alert alert-success">
            <strong>✓ <span id="tbmkyResultMessage">生成成功！</span></strong>
          </div>

          <div id="tbmkyFilesList" class="tbmky-files-list">
            <!-- 動態生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeTBMKYResultModal()">
            <span class="btn-icon">✓</span>
            <span>確定</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：日曆詳情 -->
    <!-- ============================================ -->
    <div id="calendarDetailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>日期詳情：<span id="detailDateTitle"></span></h3>
          <button class="modal-close" onclick="closeCalendarDetailModal()">×</button>
        </div>
        <div class="modal-body">
          <div id="calendarDetailContent">
            <!-- 動態生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeCalendarDetailModal()">關閉</button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：統一確認視窗 -->
    <!-- ============================================ -->
    <!-- 忘記密碼 Modal -->
    <div id="forgotPasswordModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3>🔑 忘記密碼</h3>
          <button class="modal-close" onclick="closeForgotPasswordModal()">×</button>
        </div>
        <div class="modal-body">
          <p style="color: #6b7280; margin-bottom: 1.5rem;">
            請輸入您的帳號或註冊信箱，系統將發送臨時密碼至您的信箱。
          </p>
          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">👤</span>
              <span>帳號或信箱</span>
            </label>
            <input type="text" id="forgotPasswordInput" class="form-input" placeholder="請輸入帳號或電子信箱" required>
          </div>
          <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <p style="color: #92400e; font-size: 0.875rem; margin: 0;">
              💡 臨時密碼將發送至您註冊時填寫的信箱，請登入後立即變更密碼。
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeForgotPasswordModal()">取消</button>
          <button type="button" class="btn btn-primary" onclick="submitForgotPassword()">
            <span class="btn-icon">📧</span>
            <span>發送臨時密碼</span>
          </button>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="modal">
      <div class="modal-content modal-confirm">
        <div class="modal-header">
          <h3>⚠️ 請確認操作</h3>
          <button class="modal-close" onclick="closeConfirmModal()">×</button>
        </div>
        <div class="modal-body">
          <div id="confirmMessage" class="confirm-message">
            <!-- 動態內容 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">取消</button>
          <button type="button" id="confirmBtn" class="btn btn-primary">
            <span class="btn-icon">✓</span>
            <span>確認執行</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 頁籤6：使用者管理 -->
    <!-- ============================================ -->
    <div id="userManagement" class="tab-pane">
      <div class="page-header">
        <h2 id="userManagementTitle">使用者管理</h2>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <p id="userManagementHint" style="display: none; margin: 0; color: #6b7280; font-size: 0.875rem;">
            💡 提示：欲設定承攬商填表人資料及其可填寫的工程限制，請勾選對應的管理工程序號
          </p>
          <button class="btn btn-primary" onclick="openAddUserModal()">
            <span>➕ 新增使用者</span>
          </button>
        </div>
      </div>

      <!-- 篩選區 -->
      <div
        style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <!-- 角色篩選 -->
          <div style="flex: 1; min-width: 200px;">
            <label
              style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem; font-size: 0.875rem;">🎭
              角色篩選</label>
            <select id="userRoleFilter" class="form-select" onchange="applyUserFilters()" style="width: 100%;">
              <option value="all">全部角色</option>
              <option value="超級管理員">超級管理員</option>
              <option value="聯絡員">聯絡員</option>
              <option value="填表人">填表人</option>
            </select>
          </div>

          <!-- 部門篩選 -->
          <div style="flex: 1; min-width: 200px;">
            <label
              style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem; font-size: 0.875rem;">🏢
              部門篩選</label>
            <select id="userDeptFilter" class="form-select" onchange="applyUserFilters()" style="width: 100%;">
              <option value="all">全部部門</option>
              <!-- 動態生成 -->
            </select>
          </div>

          <!-- 搜尋框 -->
          <div style="flex: 2; min-width: 250px;">
            <label
              style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem; font-size: 0.875rem;">🔍
              搜尋</label>
            <input type="text" id="userSearchInput" class="form-input" placeholder="搜尋姓名、帳號、Email..."
              oninput="applyUserFilters()" style="width: 100%;">
          </div>

          <!-- 清除按鈕 -->
          <div style="align-self: flex-end;">
            <button class="btn" onclick="clearUserFilters()"
              style="background: #6b7280; color: white; padding: 0.625rem 1.25rem;">
              🔄 清除篩選
            </button>
          </div>
        </div>

        <!-- 統計資訊 -->
        <div id="userFilterStats"
          style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.875rem;">
          <span>📊 共 <strong id="userTotalCount" style="color: #3b82f6; font-size: 1.1rem;">0</strong> 位使用者</span>
        </div>
      </div>

      <!-- 使用者列表 -->
      <div id="userListContainer" class="card-container">
        <!-- 動態生成 -->
      </div>
    </div>

    <!-- ============================================ -->
    <!-- 彈窗：新增/編輯使用者 -->
    <!-- ============================================ -->
    <div id="addUserModal" class="modal">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header"
          style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem 2rem;">
          <h3 id="addUserModalTitle" style="margin: 0; font-size: 1.5rem; font-weight: 700;">新增使用者</h3>
          <button class="btn-icon" onclick="closeAddUserModal()"
            style="background: rgba(255,255,255,0.2); color: white;">
            <span class="icon">✕</span>
          </button>
        </div>

        <div class="modal-body" style="padding: 2rem;">
          <input type="hidden" id="editUserRowIndex">

          <!-- 兩欄佈局 -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <!-- 左欄 -->
            <div>
              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label
                  style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">🏢</span>
                  <span>部門</span>
                </label>
                <select id="userDept" class="form-select"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                  <option value="">請選擇部門</option>
                </select>
              </div>

              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label
                  style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">👤</span>
                  <span>姓名</span>
                  <span style="color: #ef4444; font-size: 1.1rem;">*</span>
                </label>
                <input type="text" id="userName" placeholder="例如：王小明" required class="form-input"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
              </div>

              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label
                  style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">🔑</span>
                  <span>帳號</span>
                  <span style="color: #ef4444; font-size: 1.1rem;">*</span>
                </label>
                <input type="text" id="userAccount" placeholder="例如：wang001" required class="form-input"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; font-family: monospace;">
              </div>
            </div>

            <!-- 右欄 -->
            <div>
              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label
                  style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">📧</span>
                  <span>Email</span>
                  <span style="color: #ef4444; font-size: 1.1rem;">*</span>
                </label>
                <input type="email" id="userEmail" placeholder="例如：wang@example.com" required class="form-input"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
              </div>

              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label
                  style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">👔</span>
                  <span>身分</span>
                  <span style="color: #ef4444; font-size: 1.1rem;">*</span>
                </label>
                <select id="userRole" onchange="handleRoleChange()" required class="form-select"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                  <option value="填表人">填表人</option>
                  <option value="聯絡員">聯絡員</option>
                  <option value="超級管理員">超級管理員</option>
                </select>
              </div>

              <div class="form-group" style="margin-bottom: 1.5rem;">
                <label
                  style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">🔐</span>
                  <span>密碼</span>
                  <span id="passwordRequired" style="color: #ef4444; font-size: 1.1rem;">*</span>
                </label>
                <input type="password" id="userPassword" placeholder="請輸入密碼" class="form-input"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                <small id="passwordHint"
                  style="display: none; color: #6b7280; font-size: 0.85rem; margin-top: 0.25rem; display: block;">編輯時，留空表示不修改密碼</small>
              </div>
            </div>
          </div>

          <!-- 主管 Email（全寬） -->
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label
              style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
              <span style="font-size: 1.25rem;">👔</span>
              <span>主管 Email</span>
            </label>
            <input type="email" id="userSupervisorEmail" placeholder="例如：supervisor@example.com" class="form-input"
              style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
          </div>

          <!-- 管理工程（全寬，摺疊式） -->
          <div class="form-group" id="managedProjectsGroup" style="display: none;">
            <label
              style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">
              <span style="font-size: 1.25rem;">🏗️</span>
              <span>管理工程序號</span>
              <span style="color: #ef4444; font-size: 1.1rem;">*</span>
            </label>
            <div
              style="background: #f9fafb; padding: 1.25rem; border-radius: 12px; border: 2px solid #e5e7eb; max-height: 400px; overflow-y: auto;">
              <div id="managedProjectsCheckboxes" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- 動態生成部門分組 -->
              </div>
            </div>
            <small
              style="color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem; display: block;">選擇此填表人可填寫的工程（可按部門快速全選）</small>
          </div>
        </div>

        <div class="modal-footer"
          style="padding: 1.5rem 2rem; background: #f9fafb; border-top: 2px solid #e5e7eb; display: flex; gap: 1rem; justify-content: flex-end;">
          <button class="btn" onclick="closeAddUserModal()"
            style="padding: 0.75rem 2rem; font-size: 1rem; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            取消
          </button>
          <button class="btn btn-primary" onclick="confirmAddUser()"
            style="padding: 0.75rem 2rem; font-size: 1rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
            確認
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Loading 動畫 -->
    <!-- ============================================ -->
    <div id="loadingOverlay" class="loading">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">處理中，請稍候...</div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Toast 通知（修正9：z-index提高） -->
    <!-- ============================================ -->
    <div id="toast" class="toast"></div>

    <script src="./app.js?v=3"></script>
</body>

</html>